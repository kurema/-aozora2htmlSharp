# RubyとC#の違い
## 型
Rubyは動的型付け言語で、C#は静的型付け言語です。
なので、Ruby版では同じ名前の変数に色んな型が来る設計になってました。
C#でも同じようなことは出来るのですが(dynamic/object)、出来れば避けました。

またC#では一文字のcharと複数文字のstringを区別しますが、Rubyではしないようです。
この点は結構面倒でした。

## 名前
Rubyはスネークケース(snake_case)が多く、C#はパスカルケース(PascalCase)が多いです。
移植時は混乱しないようにC#でもRuby版の名前をそのまま踏襲しました。
一段落してから名前を一括で変更します。

またRuby版ではC#の予約語を変数名に使っていることが多々ありました(string/char)。
C#では予約語でも先頭に@を付けると使えるので、そのまま変更せず使いました。
先頭@変数名の意味がRubyとC#でだいぶ異なるので注意が必要です。

## 文字コード
RubyではShiftJIS文字列をそのまま扱うことができます。
C#(dotnet)の文字列はUTF16です。
ですから、入力時と出力時に二回変換を噛ませることになります。

プログラミング時の注意としては、正規表現の表記が変わる場合がある点です。
例えば``[亜-熙々※仝〆〇ヶ]``のようなShiftJISでの並びに依存していそうなものは注意が必要です。
だいたいはUnicodeに入れる時に順番が維持されていると思うので、割と大丈夫なことが多いと思います。

## Match
Ruby版では何故か正規表現を用いない場合も``string.match()``を使っていましたが、C#版では``string.Contains()``に置き換えました。
またC#では``string``のメソッドに正規表現に関わる物がないので順番が変わります。
例えば``string.gsub!(PAT_RUBY, '')``が``PAT_RUBY.Replace(@string, string.Empty);``になります。

## 空ブロック
Rubyユーザーが少し混乱しそうな物として空ブロックを挙げます。
つまり特に意味もなさそうな場所で``{}``で囲うパターンです。
これは単に変数のスコープをそのブロック内に留める目的で、コピペする時とかに便利です。
そんなに大した意味はありません。

ただ知らないとたまに混乱の原因になります。
例えば下の場合、``DoOthers()``は必ず実行されます。
当たり前っちゃ当たり前ですが、見た目紛らわしいです。
こういう場合はさすがに空行を入れるべきですね。
```
if ( condition ) DoSomething();
{
  DoOthers();
}
```

## 配列
RubyではArrayに``push()``とか``pop()``とか``unshift()``とかありますが、C#では配列・``List<>``・``Stack<>``が別々にあります。
基本は``List<>``を使っていれば困りません。
System.Collections.Generic 名前空間です。
それからジェネリクスという物がありますが、難しいので説明は割愛します。

## 名前空間
C#には名前空間という概念があります。
これは要するにクラスとかのフォルダです。
先頭の``using ...;``はその名前空間内のクラスとかをソースコード内で使えるようにするためのものです。

きちんとした説明は検索してください。

クラスと名前空間の名前が衝突しないように名前を変更しています。

1. 全体が`Aozora`名前空間以下。
2. `Aozora2Html`クラスは名前がそのままで、名前空間付きだと`Aozora.Aozora2Html`。
3. Rubyでは`Aozora2Html`の内部クラスだったものが、`Aozora.Helper`に配置されています(C#にも内部クラスはあります)。

## String
RubyのStringには破壊的なメソッドがあります。例えばconcatです。
C#のStringは基本破壊できません()。
その関係で、普通に文字列結合すると遅いので(結合の度に新しいものが出来る)、文字列結合をする場合には``StringBuilder``(System.Text 名前空間)を使います。
StringBuilderの文字列を結合する場合には``Append()``を使い、``string``にするには``ToString``(Rubyの``to_s``)を使います。

## 文字列
C#では特殊な文字列リテラルとして、`$""`と`@""`があります。
`$""`は`{}`を使った文字列補完をするもので、`@""`は`\`がエスケープシーケンスと見做されないものです。
後者は正規表現でよく使います。
両者は組み合わせることができます。

Rubyでは文字列補完に文字列内での`#{}`を使います。
Rubyの文字列補完をC#の`$""`に置き換えるなら`#`を取り除く必要があります。

# Ruby版とC#版の違い
こちらは言語仕様とは関係ない話です。

## yaml
Ruby版はyamlファイルを読み込んでいた物を、こちらではソースコードに埋め込むことにしました。
その際``switch``を使っています。
これはC#の``switch``はジャンプテーブルに変換され高速なのと、シリアライズや文字コード変換のコストが掛からないからです。

## to_s
Ruby版では`to_s`でHTML出力する形式でしたが、C#版ではHTML出力は`to_html()`に変更しました。
`ToString()`でHTMLが出力されるのに違和感があったのと、将来HTML出力以外をサポートする場合を考えてのことですが、あまりHTML以外に対応できるつくりではありません。
`to_html()`メソッドを持つクラスは`IHtmlProvider`インターフェースを継承しています。

## Unpacked
Rubyで`unpack1('H*')`後に比較していたものと同様の表現が可能なように、独自にUnpackedクラスを作成しました。
演算子オーバーロードを利用して、以下のように使えます。

```cs
var code = new Unpacked('あ');
if("00" <= code && code <= "7f"){}
```

## --error-utf8
--error-utf8は廃止しています。

# 将来

## 正規表現
.NET 7以降では正規表現をコンパイル結果で埋め込める``[RegexGenerator]``が使えるようになります。
今回は正規表現を多用しているので、処理時間が多少は速くなるかも知れません。
ただ今回このライブラリを移植した目的がUWPのアプリ([BookViewer 3](https://github.com/marketplace))で使うためなので、.NET 7以降でしか動かないのは困ります。
複数ターゲットでコンパイルすれば良いのかな？

## Span
最近のdotnetだと`Span`で高速化するというのが流行りです。
私はあんまり速度を詰めなることがなく`Span`を使った経験もないのでやりませんでした。
固定長の文字列編集とかで使えそうな場面もあったような気がします。
